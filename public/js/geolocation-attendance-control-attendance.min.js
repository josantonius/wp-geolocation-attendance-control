document.addEventListener("DOMContentLoaded",function(){Vue.component("gmap-map",VueGoogleMaps.Map),Vue.component("VueGoogleMapsPlacesAggregator",VueGoogleMapsPlacesAggregator.VueGoogleMapsPlacesAggregator),Vue.use(VueGoogleMaps,{load:{key:geolocationAttendanceControlAttendance.google_api_key}}),new Vue({el:"#app",data:e=>({selected:[],search:"",headerTitle:"Asistencias",place:null,centre:"",activity:"",startDateSelector:!1,endDateSelector:!1,startDate:moment().toISOString().substr(0,10),endDate:moment().toISOString().substr(0,10),startTime:!1,start_hour:null,endTime:!1,end_hour:null,pagination:{descending:!0,page:1,rowsPerPage:10,sortBy:"id"},placeholder:"Dirección",className:"",id:"",value:"",options:{componentRestrictions:{country:"es"}},currentID:null,zoom:10,center:{lat:37.392529,lng:-5.994072},width:"100%",page:"attendances",height:"400px",maxHeight:"400px",maxWidth:"100%",markers:[],toolbarTitle:"Asistencias",toolbarColor:"indigo",formatDate:"DD [de] MMMM [de] YYYY",formatHour:"hh:mm",defaultDateOrder:"DEC",defaultHourOrder:"DEC",locale:"es",dialog:!1,dialogConfirm:!1,dialogTitle:"",dialogSubtitle:"",dateSelectorDialog:!0,headers:[{text:"ID",align:"left",value:"id",sortable:!0},{text:"Acción",align:"center",value:"action",sortable:!1},{text:"Hora",value:"hour",sortable:!1,align:"center"},{text:"Nombre",value:"user_fullname",sortable:!0,align:"right"},{text:"Centro",value:"centre_name",sortable:!0,align:"right"},{text:"Actividad",value:"activity_name",sortable:!0,align:"right"},{text:"Fecha",value:"date",sortable:!0,align:"right"},{text:"Acciones",value:"centre",sortable:!1,align:"center"}],editedIndex:-1}),mounted(){this.selectAttendances()},methods:{getTemplate:(e,t,a,o,i)=>`\n          <div id="content">\n            <div class="gac-heading">\n              <h1 class="gac-first-heading">${e}</h1>\n              <h3 class="gac-second-heading">${t} - ${a} - ${o}</span></h3>\n              \n            </div>\n            <div id="bodyContent">\n              <p>${i}</p>\n            </div>\n          </div>\n        `,request(e,t,a){var o=new URLSearchParams;for(var i in a=a||{},o.append("action",t),o.append("nonce",geolocationAttendanceControlAttendance.nonce),a)o.append(i,a[i]);return new Promise((t,a)=>axios({method:e,url:geolocationAttendanceControlAttendance.ajax_url,data:o}).then(e=>{console.log(e),t(e.data)}).catch(e=>{console.log(e),a(e)}))},selectAttendances(){var e={start_date:moment(this.startDate).format("YYYY-MM-DD"),end_date:moment(this.endDate).format("YYYY-MM-DD")};this.request("post","select_attendances",e).then(e=>{console.log(e),this.markers=[],e.forEach(e=>{e.infoText=this.getTemplate(e.user_fullname,e.action,moment(e.date).format("HH:mm"),e.address),e.position={lat:parseFloat(e.latitude),lng:parseFloat(e.longitude)},e.hour=moment(e.date).format("HH:mm"),e.fullhour=moment(e.date).format("HH:mm:ss"),e.date=moment(e.date).format("DD-M-YYYY"),e.value=!1,e.clickable=!0,this.addMarker(e)}),document.querySelector(".opacity-on").classList.add("opacity-off")}).catch(e=>{console.log(e)})},getTemplate:(e,t,a,o)=>`\n          <div id="content">\n            <div class="gac-heading">\n              <h1 class="gac-first-heading">${e}</h1>\n              <h3 class="gac-second-heading">${t} a las ${a}.</span></h3>\n              \n            </div>\n            <div id="bodyContent">\n              <p>${o="Desconocida"===o?"Dirección desconocida":o}</p>\n            </div>\n          </div>\n        `,insertCentre(){var e={centre:this.centre,activity:this.activity,start_hour:this.start_hour,end_hour:this.end_hour,latitude:this.place.location.lat,longitude:this.place.location.lng,address:this.place.formatted_address,place_id:this.place.place_id};this.request("post","insert_centre",e).then(e=>{e&&this.save(e)}).catch(e=>{console.log(e)})},createCSV(e,t){var a=[];e.forEach(e=>{a.push({ID:e.id.replace(/,/g,"").trim(),NOMBRE:e.user_first_name.replace(/,/g,"").trim(),APELLIDOS:e.user_last_name.replace(/,/g,"").trim(),DNI:e.user_dni.replace(/,/g,"").trim(),IP:e.user_ip?e.user_ip.replace(/,/g,"").trim():"",CENTRO:e.centre_name.replace(/,/g,"").trim(),ACTIVIDAD:e.activity_name.replace(/,/g,"").trim(),"DIRECCIÓN":e.centre_address.replace(/,/g,"").trim(),"ACCIÓN":e.action.replace(/,/g,"").trim(),HORA:e.hour.replace(/,/g,"").trim(),FECHA:e.date.replace(/,/g,"").trim(),"UBICACIÓN VÁLIDA":parseInt(e.action_status)?"Sí":"No","HORARIO VÁLIDO":parseInt(e.hour_status)?"Sí":"No",FECHA:e.date.replace(/,/g,"").trim(),LATITUD:e.latitude.replace(/,/g,"").trim(),LONGITUD:e.longitude.replace(/,/g,"").trim()})});var o=a,i=this.JSON2CSV(o),n=document.createElement("a"),s=new Blob(["\ufeff",i]),r=URL.createObjectURL(s);n.href=r,n.download=t?"registros-desde-el-"+moment(this.startDate).format("DD-MM-YY")+"-hasta-"+moment(this.endDate).format("DD-MM-YY")+".csv":"registros-seleccionados-"+moment(this.startDate).format("DD-MM-YY")+".csv",document.body.appendChild(n),n.click(),document.body.removeChild(n)},onOpenMarker(e,t){console.info("onOpenMarker",e,t)},onCloseMarker(e,t){console.info("onCloseMarker",e,t)},onCLickMarker(e,t){console.info("onCLickMarker",e,t)},onKeyUp(e){console.info("onKeyUp",e)},JSON2CSV(e){var t="object"!=typeof e?JSON.parse(e):e,a="",o="";t[0];for(var i in t[0])o+=i+",";a+=(o=o.slice(0,-1))+"\r\n";for(var n=0;n<t.length;n++){o="";for(var i in t[n])o+=t[n][i].replace(/,/g,"").trim()+",";a+=(o=o.slice(0,-1))+"\r\n"}return a},onKeyPress(e){console.info("onKeyPress",e)},onFocus(){console.info("onFocus")},onBlur(){console.info("onBlur")},onChange(){console.info("onChange")},onPlaceChanged(e){this.place=e,console.info("onPlaceChanged",e)},clear(){this.$refs.autocomplete.clear()},deleteItemAsk(e){this.dialogTitle="Eliminar registro",this.dialogSubtitle="¿Eliminar el registro "+e.id+"?",this.dialogConfirm=!0,this.currentID=e.id},deleteItems(){this.dialogTitle="",this.dialogSubtitle="",this.dialogConfirm=!1,null!==this.currentID?this.deleteAttendance(this.currentID):this.deleteSelectedItems()},deleteItemsAsk(){this.dialogTitle="Eliminar registros",this.dialogSubtitle="¿Eliminar los registros seleccionados?",this.dialogConfirm=!0},deleteSelectedItems(){this.selected.forEach(e=>{this.deleteAttendance(e.id)}),this.selected=[]},deleteAttendance(e){var t={id:e};this.request("post","delete_attendance",t).then(t=>{if(t){var a=this.markers.findIndex(t=>t.id===e);this.markers.splice(a,1)}}).catch(e=>{console.log(e)})},close(){this.dialog=!1,this.resetForm()},save(e){this.addMarker({id:e,centre:this.centre,activity:this.activity,start_hour:this.start_hour,end_hour:this.end_hour,latitude:this.place.location.lat,longitude:this.place.location.lng,position:{lat:this.place.location.lat,lng:this.place.location.lng},address:this.place.formatted_address,place_id:this.place.place_id,clickable:!0,infoText:this.getTemplate(this.centre,this.activity,this.start_hour,this.end_hour,this.place.formatted_address)}),this.centerMap(this.place.location),this.close(),this.zoomMap(15)},goToMarker(e){this.$refs.google_maps_places_aggregator.infoWinOpen=!1,this.$refs.google_maps_places_aggregator.infoWindowPos=e.position,this.$refs.google_maps_places_aggregator.infoOptions.content=e.infoText,this.$refs.google_maps_places_aggregator.infoWinOpen=!0,this.centerMap(e.position),this.zoomMap(15)},addMarker(e){this.markers.push(e)},centerMap(e){this.center=e},zoomMap(e){this.zoom=e},resetForm(){this.centre="",this.activity="",this.start_hour=null,this.end_hour=null,this.place=null},saveDate(e){"start"===e?this.$refs.start_date_selector.save(this.startDate):this.$refs.end_date_selector.save(this.endDate),this.selectAttendances(),this.$vuetify.goTo("#gac-datatable")}},watch:{dialog(e){e||this.close()}},computed:{formattedStartDate(){return moment(this.startDate).format("DD-MM-YY")},formattedEndDate(){return moment(this.endDate).format("DD-MM-YY")},valid:function(){return""!==this.centre&&""!==this.activity&&this.start_hour&&this.end_hour&&this.place},formTitle(){return-1===this.editedIndex?"New Item":"Edit Item"}}})});