document.addEventListener("DOMContentLoaded",function(){Vue.component("gmap-map",VueGoogleMaps.Map),Vue.component("VueGoogleMapsPlacesAggregator",VueGoogleMapsPlacesAggregator.VueGoogleMapsPlacesAggregator),Vue.use(VueGoogleMaps,{load:{key:geolocationAttendanceControl.google_api_key}}),new Vue({el:"#app",data:e=>({selectedActivity:null,selectedCentre:null,selectedSchedule:null,schedulesList:[],centres:[],activities:[],activitiesList:[],position:null,errorMessage:null,successMessage:null,positionReceived:null,selected:[],search:"",headerTitle:"Asistencias",place:null,centre:"",activity:"",startDateSelector:!1,endDateSelector:!1,startDate:"",endDate:"",startTime:!1,start_hour:null,endTime:!1,end_hour:null,pagination:{descending:!0,page:1,rowsPerPage:10,sortBy:"id"},placeholder:"Dirección",className:"",id:"",value:"",options:{componentRestrictions:{country:"es"}},currentIndex:null,zoom:10,center:{lat:37.392529,lng:-5.994072},geolocationOptions:{enableHighAccuracy:!1,timeout:1/0,maximumAge:0},width:"100%",page:"attendances",height:"400px",maxHeight:"600px",maxWidth:"400px",markers:[],toolbarTitle:"Asistencias",toolbarColor:"indigo",formatDate:"DD [de] MMMM [de] YYYY",formatHour:"hh:mm",defaultDateOrder:"DEC",defaultHourOrder:"DEC",locale:"es",dialog:!1,dialogConfirm:!1,dialogTitle:"",dialogSubtitle:"",dateSelectorDialog:!0,editedIndex:-1}),mounted(){setTimeout(function(){document.querySelector(".opacity-on").classList.add("opacity-off")},100),this.getCurrentPosition(this.geolocationOptions).then(e=>{e.coords?(this.position={lat:e.coords.latitude,lng:e.coords.longitude},this.selectActivities(),this.save(),console.log(this.position)):this.errorMessage="NO PUEDES CONTINUAR: LA GEOLOCALIZACIÓN NO ES COMPATIBLE CON TU NAVEGADOR."}).catch(e=>{console.error("ERR",e.message);switch(e.code){case e.PERMISSION_DENIED:this.errorMessage="NO PUEDES CONTINUAR: DENEGASTE EL ACCESO A TU UBICACIÓN.";break;case e.POSITION_UNAVAILABLE:this.errorMessage="NO PUEDES CONTINUAR: LA INFORMACIÓN SOBRE TU UBICACIÓN NO ESTÁ DISPONIBLE.";break;case e.TIMEOUT:this.errorMessage="NO PUEDES CONTINUAR: LA SOLICITUD PARA OBTENER TU UBICACIÓN HA SUPERADO EL TIEMPO DE ESPERA.";break;case e.UNKNOWN_ERROR:this.errorMessage="NO PUEDES CONTINUAR: SE HA PRODUCIDO UN ERROR DESCONOCIDO."}})},methods:{getLoaderPointsImage:()=>geolocationAttendanceControl.loader_gif,getLoaderImage:()=>geolocationAttendanceControl.location_loader_gif,getErrorImage:()=>geolocationAttendanceControl.location_error_gif,getCurrentPosition:e=>navigator.geolocation?new Promise(function(t,i){navigator.geolocation.getCurrentPosition(t,i,e)}):new Promise(e=>e({})),selectActivities(){this.activities=[],this.request("post","select_activities").then(e=>{this.activities=e,this.activities.forEach((e,t)=>{-1===this.centres.findIndex(t=>t.centre===e.centre)&&this.centres.push({id:e.centre_id,centre:e.centre})}),console.log(e)}).catch(e=>{console.log(e)})},onChangeCentre(){this.activitiesList=[],this.schedulesList=[],this.selectedActivity=null,this.selectedSchedule=null,this.activities.forEach((e,t)=>{-1===this.activitiesList.findIndex(t=>t.activity===e.activity_id)&&e.centre_id===this.selectedCentre.id&&this.activitiesList.push({id:e.id,activity:e.activity})})},onChangeActivity(){this.schedulesList=[],this.selectedSchedule=null,this.activities.forEach((e,t)=>{e.centre_id===this.selectedCentre.id&&e.activity===this.selectedActivity.activity&&this.schedulesList.push({id:e.id,schedule:e.start_hour+" - "+e.end_hour})})},request(e,t,i){var s=new URLSearchParams;for(var o in i=i||{},s.append("action",t),s.append("nonce",geolocationAttendanceControl.nonce),i)s.append(o,i[o]),console.log(o,i[o]);return new Promise((t,i)=>axios({method:e,url:geolocationAttendanceControl.ajax_url,data:s}).then(e=>{t(e.data)}).catch(e=>{console.log(e),i(e)}))},selectAttendances(){},save(){this.addMarker({position:this.position,clickable:!1,infoText:""}),this.centerMap(this.position),this.close(),this.zoomMap(15)},setAttendance(e){var t={latitude:this.position.lat,longitude:this.position.lng,activity_id:this.selectedSchedule.id,attendance_action:e};this.request("post","set_attendance",t).then(e=>{console.log(e),e?(this.positionReceived=!0,this.markers=[],e.infoText=this.getTemplate(e.hour,this.position.lat,this.position.lng,e.address),e.position=this.position,e.hour=e.hour,e.value=!1,e.clickable=!0,this.addMarker(e),this.centerMap(this.position),this.zoomMap(15),this.goToMarker(e),e.error_msg?this.errorMessage=e.error_msg:e.success_msg&&(this.successMessage=e.success_msg)):this.errorMessage="NO PUEDES CONTINUAR: SE HA PRODUCIDO UN ERROR AL CONTECTAR CON LA BASE DE DATOS."}).catch(e=>{console.log(e)})},getTemplate:(e,t,i,s)=>`\n          <div id="the-contents">\n            <div class="gac-heading">\n            <h3 style="text-align: center; margin-top: 2px;" class="gac-second-heading">${t}, ${i}</span></h3>\n            </div>\n            <div id="bodyContent">\n              <p style="text-align: center; margin-bottom: 0px;">${s}</p>\n            </div>\n          </div>\n        `,deleteAttendance(){var e={id:this.markers[this.currentIndex].id};this.request("post","delete_attendance",e).then(e=>{e&&(this.markers.splice(this.currentIndex,1),this.currentIndex=null)}).catch(e=>{console.log(e)})},onOpenMarker(e,t){console.info("onOpenMarker",e,t)},onCloseMarker(e,t){console.info("onCloseMarker",e,t)},onCLickMarker(e,t){console.info("onCLickMarker",e,t)},onKeyUp(e){console.info("onKeyUp",e)},onKeyPress(e){console.info("onKeyPress",e)},onFocus(){console.info("onFocus")},onBlur(){console.info("onBlur")},onChange(){console.info("onChange")},onPlaceChanged(e){this.place=e,console.info("onPlaceChanged",e)},clear(){this.$refs.autocomplete.clear()},deleteItemAsk(e){this.dialogTitle="Eliminar registro",this.dialogSubtitle="¿Eliminar el registro "+e.id+"?",this.dialogConfirm=!0,this.currentIndex=this.markers.indexOf(e)},deleteItems(){this.dialogTitle="",this.dialogSubtitle="",this.dialogConfirm=!1,null!==this.currentIndex?this.deleteAttendance():this.deleteSelectedItems()},deleteItemsAsk(){this.dialogTitle="Eliminar registros",this.dialogSubtitle="¿Eliminar los registros seleccionados?",this.dialogConfirm=!0},deleteSelectedItems(){this.selected.forEach(e=>{this.currentIndex=this.markers.indexOf(e),this.deleteAttendance()}),this.selected=[]},close(){this.dialog=!1,this.resetForm()},save(){this.addMarker({position:this.position,clickable:!1,infoText:""}),this.centerMap(this.position),this.close(),this.zoomMap(15)},goToMarker(e){this.$refs.google_maps_places_aggregator.infoWinOpen=!1,this.$refs.google_maps_places_aggregator.infoWindowPos=e.position,this.$refs.google_maps_places_aggregator.infoOptions.content=e.infoText,this.$refs.google_maps_places_aggregator.infoWinOpen=!0,this.centerMap(e.position),this.zoomMap(15)},addMarker(e){this.markers.push(e)},centerMap(e){this.center=e},zoomMap(e){this.zoom=e},resetForm(){this.centre="",this.activity="",this.start_hour=null,this.end_hour=null,this.place=null},saveDate(e){"start"===e?this.$refs.start_date_selector.save(this.startDate):this.$refs.end_date_selector.save(this.endDate),this.selectAttendances()}},watch:{dialog(e){e||this.close()}},computed:{formattedStartDate(){return moment(this.startDate).format("DD-MM-YY")},formattedEndDate(){return moment(this.endDate).format("DD-MM-YY")},valid:function(){return""!==this.centre&&""!==this.activity&&this.start_hour&&this.end_hour&&this.place},formTitle(){return-1===this.editedIndex?"New Item":"Edit Item"}}})});